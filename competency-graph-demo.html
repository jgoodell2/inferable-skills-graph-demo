<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Competency Graph + Item Simulator</title>
  <style>
    :root{box-sizing:border-box}
    *{box-sizing:inherit}
    html,body{height:100%;margin:0;font-family:Arial, sans-serif}
    .split-container{display:flex;height:100vh;width:100vw}
    .left-pane{width:33%;min-width:300px;background:#f4f6f8;overflow:auto;padding:12px}
    .right-pane{flex:1;background:#f8f9fa;position:relative;overflow:auto;padding:12px}
    #tooltip{position:absolute;background:rgba(0,0,0,0.75);color:#fff;padding:6px;border-radius:4px;font-size:12px;pointer-events:none;visibility:hidden;z-index:2000}
    /* keep some styles from itemsim for left pane content */
    #divBackground{width:100%;padding:16px;background:#133b61;color:#000}
  #divActivity{margin:auto;width:100%;background:#fff;padding:10px;border-radius:4px;height:auto;display:inline-block}
    #feedback{color:blue;background-color:white;padding:8px}
    button{cursor:pointer}

    /* Responsive: stack panes vertically on small screens */
    @media (max-width: 800px) {
      .split-container { flex-direction: column; }
      .left-pane { width: 100%; height: 45vh; min-width: 0; }
      .right-pane { width: 100%; height: 55vh; }
      /* ensure the graph SVG covers the right pane when stacked */
      #graphArea svg#arrows { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    }
  </style>
  <!-- percent-gauge webcomponent -->
  <script src="https://jgoodell2.github.io/itemGen/webComponents/percentGauge.js" type="module"></script>
  <!-- xAPI helper scripts from repo -->
  <script src="./js/jimsxapiwrapper.js"></script>
  <script src="./js/cryptojs_v3.1.2.js"></script>
  <script src="./js/xAPIWrapper.js"></script>
</head>
<body>
  <div class="split-container">
    <div class="left-pane">
      <h3>Item Simulator</h3>
      <form id="skillForm" style="background:#fff;padding:8px;border-radius:4px">
        <label for="skills">Skill:</label>
        <select id="skill" name="skill" onchange="changeSkill()">
          <!-- Options will be populated from competencyDataFractions.json -->
        </select>
      </form>

      <!--<div style="margin-top:8px">Simulated User: https://example.com/users/user-v1:1abcb33beeb811dca15f0ac3e47b887b<br/>Simulated Competency Id: <span id="comp">https://example.org/scd/math/de553a31-8298-4a77-9f36-f7845d376840</span></div>
    -->
      <div id="divBackground">
        <div id="divActivity"><button id="nextitembutton">Start</button></div>

        <!-- three hidden items (copied from itemsim.html) -->
        <div id="item001.html" style="visibility: hidden">
            <!-- The learning activity or item is enclosed in a div tag with the id "learningActivity" -->
            <div id="learningActivity" itemscope itemtype="http://schema.org/CreativeWork">
            <!-- Template CSS -->
            <style>
              i, #variable {color: blue;}
              span.frac {display: inline-block; text-align: center; vertical-align: middle;}
              span.frac > sup, span.frac > sub {display: block; font: inherit; padding: 0 0.3em;}
              span.frac > sup {border-bottom: 0.08em solid;}
              span.frac > span {display: none;}
              #hintTable {border: 1px solid black; font: 12px Arial, sans-serif; width: 300px;}
              #hintCell, #hintLabel {padding: 8px;}
              #hintLabel {padding: 8px; width: 20px; background-color: #dddddd; text-align:center;}
              #hint1, #hint2, #hint3, #hint4, #hint5, #hint6, #div-correct-feedback, #div-decimal-feedback {visibility: hidden;}
              #feedback {color: blue; background-color: white; text-align: left; padding: 8px;}
            </style>

            <!-- METADATA for the activity/item -->
            <meta itemprop="name" content="" />
            <meta itemprop="publisher" content="Jim Goodell" />
            <meta itemprop="datePublished" content="October 4, 2006" />
            <meta itemprop="description" content="A mathematics formative assessment item with hints for practicing solving proportions" />
            <meta itemprop="url" href="" >
            <meta itemprop="learningResourceType" content="http://purl.org/dcx/lrmi-vocabs/learningResourceType/assessmentItem"/>
            <meta itemprop="interactivityType" content="http://purl.org/dcx/lrmi-vocabs/interactivityType/mixed" />
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
                <meta property="alignmentType" content="educationalSubject" />
                <meta property="educationalFramework" content="Massachusetts DOE Mathematics Framework" />
                <meta property="targetName" content""/>
                <meta property="targetUrl" href="https://www.doe.mass.edu/frameworks/search/Map.aspx?ST_CODE=Mathematics.7.RP.A.02.c&a=1" />
            </span>
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
                <meta property="alignmentType" content="educationalSubject" />
                <meta property="educationalFramework" content="Massachusetts DOE Mathematics Framework" />
                <meta property="targetName" content""/>
                <meta property="targetUrl" href="https://www.doe.mass.edu/frameworks/search/Map.aspx?ST_CODE=Mathematics.7.RP.A.02.c&a=1" />
            </span>
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
              <span itemprop="inDefinedTermSet"
                              itemscope
                              itemtype="https://schema.org/DefinedTermSet">
                <meta property="name" content="The National Curriculum for England" />
                <meta property="targetUrl" href="https://www.gov.uk/government/collections/national-curriculum" />
              </span>
              <meta property="alignmentType" content="educationalSubject" />
              <meta property="educationalFramework" content="The National Curriculum for England" />
              <meta property="targetName" content="Solve problems involving ratio relationships." />
              <meta property="targetUrl" href="http://example.org/MA/6AS/MD-3"/>
            </span>
            <!-- Not sure if the xAPI profile should be defined here, i.e. one profile for the entire activity, or to allow separate profiles and specify by event type. -->
            <meta itemprop="xapiprofile" content="http://profiles.usalearning.net/xapi/043b24b4-4389-435f-b052-805fd5563166/v/1"/>

            <!-- Presentation starts here -->
              <!--FIRST PART is the stimulus, i.e. what is presented ot  the learner. -->
              <!--The stimulus may include any number of response objects.-->
              <!--User response events (click, drag, enter a value, etc.) may trigger actions within the html block but MUST also logged via xAPI. -->
              <!--Events logged via xAPI must use an xAPI Profile that contextualizes the activity type and response type. -->
              <!--This activity is a formative assessment item. -->
              
              <!-- Stimulus Block -->
              <div id="divStimulus">
                <p>Solve for <i>r</i>.  (enter answer as a fraction)</p><p><span class="frac"><sup>4</sup><span>&frasl;</span><sub><i>r</i></sub></span>&nbsp;=&nbsp;<span class="frac"><sup>5</sup><span>&frasl;</span><sub>7</sub></span></p></p><p><i>r</i>&nbsp;=&nbsp;
                <!-- For convenience we give the input field the id 'response' to signal that it's where we'll get the xAPI response propeerty that we'll send with other result fields such as success, completion, duration  -->
                <input id="response" type="text"></input></p>
                <button id="checkResponseButton" onclick="check()">Check Answer</button><p>Stuck? <button id="hintButton" onclick="nextHint()">Get a hint</button>&nbsp;or&nbsp;<button>Watch a video</button></p>
              </div>
              <!-- End Stimulus Block -->
              
              <!-- Feedback Block -->
              <div id="feedback"></div>

              <!-- Hints Display Block -->
              <div id="divHints">
               <div id="hint1"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 1 <br/>of<br/>5</td><td id="hintCell">
                <p>Multiply both sides by <i>r</i>.</p><p><i>r</i>&nbsp;X&nbsp;<span class="frac"><sup>4</sup><span>&frasl;</span><sub><i>r</i></sub></span>&nbsp;=&nbsp;<span class="frac"><sup>5</sup><span>&frasl;</span><sub>7</sub></span>&nbsp;X&nbsp;<i>r</i></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>
              
                <div id="hint2"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 2 <br/>of<br/>5</td><td id="hintCell">
                <p>4&nbsp;=<span class="frac"><sup>5</sup><span>&frasl;</span><sub>7</sub></span><i>r</i>&nbsp;</p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>

                <div id="hint3"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 3 <br/>of<br/>5</td><td id="hintCell">
                <p>Multiply both sides by&nbsp;<span class="frac"><sup>7</sup><span>&frasl;</span><sub>5</sub></span>.</p><p>4&nbsp;X&nbsp;<span class="frac"><sup>7</sup><span>&frasl;</span><sub>5</sub></span>&nbsp;=&nbsp;<span class="frac"><sup>5</sup><span>&frasl;</span><sub>7</sub></span>&nbsp;<i>r</i>&nbsp;X<span class="frac"><sup>7</sup><span>&frasl;</span><sub>5</sub></span></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>
              
              
                <div id="hint4"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 4 <br/>of<br/>5</td><td id="hintCell">
                <p><span class="frac"><sup>4&nbsp;X&nbsp;7</sup><span>&frasl;</span><sub>5</sub></span>&nbsp;=&nbsp;<i>r</i></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>

               <div id="hint5"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 5 <br/>of<br/>5</td><td id="hintCell">
                <p><i>r</i>&nbsp;=&nbsp;<span class="frac"><sup>28</sup><span>&frasl;</span><sub>5</sub></span></p>
                </td><td width="20px"></td></tr></table></div>
              </div>

            </div>
            <!-- END Learning Activity block -->
        </div>
        
        <div id="item002.html" style="visibility: hidden">
            <!-- The learning activity or item is enclosed in a div tag with the id "learningActivity" -->
            <div id="learningActivity" itemscope itemtype="http://schema.org/CreativeWork">
            <!-- Template CSS -->
            <style>
              i {color: blue;}
              span.frac {display: inline-block; text-align: center; vertical-align: middle;}
              span.frac > sup, span.frac > sub {display: block; font: inherit; padding: 0 0.3em;}
              span.frac > sup {border-bottom: 0.08em solid;}
              span.frac > span {display: none;}
              #hintTable {border: 1px solid black; font: 12px Arial, sans-serif; width: 300px;}
              #hintCell, #hintLabel {padding: 8px;}
              #hintLabel {padding: 8px; width: 20px; background-color: #dddddd; text-align:center;}
              #hint1, #hint2, #hint3, #hint4, #hint5, #hint6, #div-correct-feedback, #div-decimal-feedback {visibility: hidden;}
              #feedback {color: blue; background-color: white; text-align: left; padding: 8px;}
            </style>
            <!-- METADATA for the activity/item -->
            <meta itemprop="name" content="" />
            <meta itemprop="publisher" content="Jim Goodell" />
            <meta itemprop="datePublished" content="October 4, 2006" />
            <meta itemprop="description" content="A mathematics formative assessment item with hints for practicing solving proportions" />
            <meta itemprop="url" href="" >
            <meta itemprop="learningResourceType" content="http://purl.org/dcx/lrmi-vocabs/learningResourceType/assessmentItem"/>
            <meta itemprop="interactivityType" content="http://purl.org/dcx/lrmi-vocabs/interactivityType/mixed" />
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
                <meta property="alignmentType" content="educationalSubject" />
                <meta property="educationalFramework" content="Massachusetts DOE Mathematics Framework" />
                <meta property="targetName" content""/>
                <meta property="targetUrl" href="https://www.doe.mass.edu/frameworks/search/Map.aspx?ST_CODE=Mathematics.7.RP.A.02.c&a=1" />
            </span>
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
                <meta property="alignmentType" content="educationalSubject" />
                <meta property="educationalFramework" content="Massachusetts DOE Mathematics Framework" />
                <meta property="targetName" content""/>
                <meta property="targetUrl" href="https://www.doe.mass.edu/frameworks/search/Map.aspx?ST_CODE=Mathematics.7.RP.A.02.c&a=1" />
            </span>
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
              <span itemprop="inDefinedTermSet"
                              itemscope
                              itemtype="https://schema.org/DefinedTermSet">
                <meta property="name" content="The National Curriculum for England" />
                <meta property="targetUrl" href="https://www.gov.uk/government/collections/national-curriculum" />
              </span>
              <meta property="alignmentType" content="educationalSubject" />
              <meta property="educationalFramework" content="The National Curriculum for England" />
              <meta property="targetName" content="Solve problems involving ratio relationships." />
              <meta property="targetUrl" href="http://example.org/MA/6AS/MD-3"/>
            </span>
            <!-- Not sure if the xAPI profile should be defined here, i.e. one profile for the entire activity, or to allow separate profiles and specify by event type. -->
            <meta itemprop="xapiprofile" content="http://profiles.usalearning.net/xapi/043b24b4-4389-435f-b052-805fd5563166/v/1"/>

            <!-- Presentation starts here -->

              <!--FIRST PART is the stimulus, i.e. what is presented ot  the learner. -->
              <!--The stimulus may include any number of response objects.-->
              <!--User response events (click, drag, enter a value, etc.) may trigger actions within the html block but MUST also logged via xAPI. -->
              <!--Events logged via xAPI must use an xAPI Profile that contextualizes the activity type and response type. -->
              <!--This activity is a formative assessment item. -->
              <!-- Stimulus Block -->
              <div id="divStimulus">
                <p>Solve for <i>r</i>.   (enter answer as a fraction)</p><p><span class="frac"><sup>4</sup><span>&frasl;</span><sub><i>r</i></sub></span>&nbsp;=&nbsp;<span class="frac"><sup>3</sup><span>&frasl;</span><sub>10</sub></span></p></p><p><i>r</i>&nbsp;=&nbsp;
                <!-- For convenience we give the input field the id 'response' to signal that it's where we'll get the xAPI response propeerty that we'll send with other result fields such as success, completion, duration  -->
                <input id="response" type="text"></input></p>
                <button id="checkResponseButton" onclick="check()">Check Answer</button><p>Stuck? <button id="hintButton" onclick="nextHint()">Get a hint</button>&nbsp;or&nbsp;<button>Watch a video</button></p>
              </div>
              <!-- Feedback Block -->
              <div id="feedback"></div>

              <!-- Hints Display Block -->
              <div id="divHints">
               <div id="hint1"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 1 <br/>of<br/>5</td><td id="hintCell">
                <p>Multiply both sides by <i>r</i>.</p><p><i>r</i>&nbsp;X&nbsp;<span class="frac"><sup>4</sup><span>&frasl;</span><sub><i>r</i></sub></span>&nbsp;=&nbsp;<span class="frac"><sup>3</sup><span>&frasl;</span><sub>10</sub></span>&nbsp;X&nbsp;<i>r</i></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>
              
                <div id="hint2"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 2 <br/>of<br/>5</td><td id="hintCell">
                <p>4&nbsp;=<span class="frac"><sup>3</sup><span>&frasl;</span><sub>10</sub></span><i>r</i>&nbsp;</p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>

                <div id="hint3"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 3 <br/>of<br/>5</td><td id="hintCell">
                <p>Multiply both sides by&nbsp;<span class="frac"><sup>10</sup><span>&frasl;</span><sub>3</sub></span>.</p><p>4&nbsp;X&nbsp;<span class="frac"><sup>10</sup><span>&frasl;</span><sub>3</sub></span>&nbsp;=&nbsp;<span class="frac"><sup>3</sup><span>&frasl;</span><sub>10</sub></span>&nbsp;<i>r</i>&nbsp;X<span class="frac"><sup>10</sup><span>&frasl;</span><sub>3</sub></span></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>
              
              
                <div id="hint4"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 4 <br/>of<br/>5</td><td id="hintCell">
                <p><span class="frac"><sup>4&nbsp;X&nbsp;10</sup><span>&frasl;</span><sub>3</sub></span>&nbsp;=&nbsp;<i>r</i></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>

               <div id="hint5"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 5 <br/>of<br/>5</td><td id="hintCell">
                <p><i>r</i>&nbsp;=&nbsp;<span class="frac"><sup>40</sup><span>&frasl;</span><sub>3</sub></span></p>
                </td><td width="20px"></td></tr></table></div>
              </div>

            </div>
            <!-- END Learning Activity block -->
        </div>
        
        <div id="item003.html" style="visibility: hidden">
            
            <!-- The learning activity or item is enclosed in a div tag with the id "learningActivity" -->
            <div id="learningActivity" itemscope itemtype="http://schema.org/CreativeWork">
            <!-- Template CSS -->
            <style>
              i {color: blue;}
              span.frac {display: inline-block; text-align: center; vertical-align: middle;}
              span.frac > sup, span.frac > sub {display: block; font: inherit; padding: 0 0.3em;}
              span.frac > sup {border-bottom: 0.08em solid;}
              span.frac > span {display: none;}
              #hintTable {border: 1px solid black; font: 12px Arial, sans-serif; width: 300px;}
              #hintCell, #hintLabel {padding: 8px;}
              #hintLabel {padding: 8px; width: 20px; background-color: #dddddd; text-align:center;}
              #hint1, #hint2, #hint3, #hint4, #hint5, #hint6, #div-correct-feedback, #div-decimal-feedback {visibility: hidden;}
              #feedback {color: blue; background-color: white; text-align: left; padding: 8px;}
            </style>
            <!-- METADATA for the activity/item -->
            <meta itemprop="name" content="" />
            <meta itemprop="publisher" content="Jim Goodell" />
            <meta itemprop="datePublished" content="October 4, 2006" />
            <meta itemprop="description" content="A mathematics formative assessment item with hints for practicing solving proportions" />
            <meta itemprop="url" href="" >
            <meta itemprop="learningResourceType" content="http://purl.org/dcx/lrmi-vocabs/learningResourceType/assessmentItem"/>
            <meta itemprop="interactivityType" content="http://purl.org/dcx/lrmi-vocabs/interactivityType/mixed" />
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
                <meta property="alignmentType" content="educationalSubject" />
                <meta property="educationalFramework" content="Massachusetts DOE Mathematics Framework" />
                <meta property="targetName" content""/>
                <meta property="targetUrl" href="https://www.doe.mass.edu/frameworks/search/Map.aspx?ST_CODE=Mathematics.7.RP.A.02.c&a=1" />
            </span>
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
                <meta property="alignmentType" content="educationalSubject" />
                <meta property="educationalFramework" content="Massachusetts DOE Mathematics Framework" />
                <meta property="targetName" content""/>
                <meta property="targetUrl" href="https://www.doe.mass.edu/frameworks/search/Map.aspx?ST_CODE=Mathematics.7.RP.A.02.c&a=1" />
            </span>
            <span rel="educationalAlignment" typeof="https://schema.org/AlignmentObject">
              <span itemprop="inDefinedTermSet"
                              itemscope
                              itemtype="https://schema.org/DefinedTermSet">
                <meta property="name" content="The National Curriculum for England" />
                <meta property="targetUrl" href="https://www.gov.uk/government/collections/national-curriculum" />
              </span>
              <meta property="alignmentType" content="educationalSubject" />
              <meta property="educationalFramework" content="The National Curriculum for England" />
              <meta property="targetName" content="Solve problems involving ratio relationships." />
              <meta property="targetUrl" href="http://example.org/MA/6AS/MD-3"/>
            </span>
            <!-- Not sure if the xAPI profile should be defined here, i.e. one profile for the entire activity, or to allow separate profiles and specify by event type. -->
            <meta itemprop="xapiprofile" content="http://profiles.usalearning.net/xapi/043b24b4-4389-435f-b052-805fd5563166/v/1"/>

            <!-- Presentation starts here -->

              <!--The stimulus may include any number of response objects.-->
              <!--User response events (click, drag, enter a value, etc.) may trigger actions within the html block but MUST also logged via xAPI. -->
              <!--Events logged via xAPI must use an xAPI Profile that contextualizes the activity type and response type. -->
              <!--This activity is a formative assessment item. -->
              <!-- Stimulus Block -->
              <div id="divStimulus">
                <p>Solve for <i>r</i>.   (enter answer as a fraction)</p><p><span class="frac"><sup>4</sup><span>&frasl;</span><sub><i>r</i></sub></span>&nbsp;=&nbsp;<span class="frac"><sup>5</sup><span>&frasl;</span><sub>9</sub></span></p></p><p><i>r</i>&nbsp;=&nbsp;
                <!-- For convenience we give the input field the id 'response' to signal that it's where we'll get the xAPI response propeerty that we'll send with other result fields such as success, completion, duration  -->
                <input id="response" type="text"></input></p>
                <button id="checkResponseButton" onclick="check()">Check Answer</button><p>Stuck? <button id="hintButton" onclick="nextHint()">Get a hint</button>&nbsp;or&nbsp;<button>Watch a video</button></p>
              </div>
              <!-- Feedback Block -->
              <div id="feedback"></div>

              <!-- Hints Display Block -->
              <div id="divHints">
               <div id="hint1"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 1 <br/>of<br/>5</td><td id="hintCell">
                <p>Multiply both sides by <i>r</i>.</p><p><i>r</i>&nbsp;X&nbsp;<span class="frac"><sup>4</sup><span>&frasl;</span><sub><i>r</i></sub></span>&nbsp;=&nbsp;<span class="frac"><sup>5</sup><span>&frasl;</span><sub>9</sub></span>&nbsp;X&nbsp;<i>r</i></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>
              
                <div id="hint2"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 2 <br/>of<br/>5</td><td id="hintCell">
                <p>4&nbsp;=<span class="frac"><sup>5</sup><span>&frasl;</span><sub>9</sub></span><i>r</i>&nbsp;</p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>

                <div id="hint3"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 3 <br/>of<br/>5</td><td id="hintCell">
                <p>Multiply both sides by&nbsp;<span class="frac"><sup>9</sup><span>&frasl;</span><sub>5</sub></span>.</p><p>4&nbsp;X&nbsp;<span class="frac"><sup>9</sup><span>&frasl;</span><sub>5</sub></span>&nbsp;=&nbsp;<span class="frac"><sup>5</sup><span>&frasl;</span><sub>9</sub></span>&nbsp;<i>r</i>&nbsp;X<span class="frac"><sup>9</sup><span>&frasl;</span><sub>5</sub></span></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>
              
              
                <div id="hint4"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 4 <br/>of<br/>5</td><td id="hintCell">
                <p><span class="frac"><sup>4&nbsp;X&nbsp;9</sup><span>&frasl;</span><sub>5</sub></span>&nbsp;=&nbsp;<i>r</i></p>
                </td><td width="20px"><button onclick="nextHint()">Next hint</button></td></tr></table></div>

               <div id="hint5"><table id="hintTable"><tr><td id="hintLabel">Hint<br/> 5 <br/>of<br/>5</td><td id="hintCell">
                <p><i>r</i>&nbsp;=&nbsp;<span class="frac"><sup>36</sup><span>&frasl;</span><sub>5</sub></span></p>
                </td><td width="20px"></td></tr></table></div>
              </div>

            </div>
            <!-- END Learning Activity block -->

        </div>
      </div>
    </div>

    <div class="right-pane" id="graphArea">
      <h3>Competency Graph</h3>
      <div id="tooltip"></div>
      <!-- arrows svg will be appended here by script -->
    </div>
  </div>

  <script>
    // Shared configuration for xAPI LRS and BKT endpoints
    const CONFIG = {
      xapi: {
        endpoint: "https://lrs.inferable.link/xapi/",
        credentials: "8d17bca86ccfd3bf25897a70f01846dfbe621f2ff9ddb28c58c60a467aeaf6b1:37b661e683780adb9a76262b310dee32cb6413553da613a7a13621675877bb59"
      },
      bkt: {
        endpoint: "https://bkt.inferable.rest",
        headers: {
          'Accept': 'application/json'
        }
      }
    };

    // Initialize xAPI configuration
    const xapiConf = {
      "endpoint": CONFIG.xapi.endpoint,
      "auth": "Basic " + toBase64(CONFIG.xapi.credentials)
    };
    ADL.XAPIWrapper.changeConfig(xapiConf);
    console.log('xAPI Configuration initialized:', {
      endpoint: xapiConf.endpoint,
      auth: xapiConf.auth ? 'Present' : 'Missing'
    });

    // --- Itemsim logic (adapted) ---
    const feedbackObjArray = [];
    var numHints = 0; var currentHint = 0; var currentItemArrayPos = 0;
    const itemArray = ["item001.html","item002.html","item003.html"];

    function nextItem(){
      feedbackObjArray.splice(0, feedbackObjArray.length);
      if (currentItemArrayPos < itemArray.length - 1) currentItemArrayPos++; else currentItemArrayPos = 0;
      const activityDiv = document.getElementById('divActivity');
      activityDiv.innerHTML = document.getElementById(itemArray[currentItemArrayPos]).innerHTML;
      // set up example feedback for each item
      switch(currentItemArrayPos){
        case 0:
          feedbackObjArray.push({match: "28/5", matchtype:"exact", feedback:"Correct! <button onclick='nextItem()'>Keep Going</button>"});
          feedbackObjArray.push({match: ".", matchtype:"substring", feedback:"Enter the answer as a fraction rather than a decimal number."});
          numHints = 5; currentHint = 0; break;
        case 1:
          feedbackObjArray.push({match: "40/3", matchtype:"exact", feedback:"Correct! <button onclick='nextItem()'>Keep Going</button>"});
          numHints = 5; currentHint = 0; break;
        case 2:
          feedbackObjArray.push({match: "36/5", matchtype:"exact", feedback:"Correct! <button onclick='nextItem()'>Keep Going</button>"});
          numHints = 5; currentHint = 0; break;
      }
    }

    function nextHint(){ currentHint++; var hintObjectName = 'hint' + currentHint; var el = document.getElementById(hintObjectName); if (el) el.style.visibility='visible'; }

    function changeSkill(){ const skillSelector = document.getElementById('skill'); const compId = document.getElementById('comp'); if (compId) compId.innerHTML = skillSelector.value; nextItem();}

  function send_statement(item, competency, response, success){
    // Log xAPI configuration status
    console.log('Sending xAPI statement with config:', {
      endpoint: CONFIG.xapi.endpoint,
      auth: 'Basic ' + toBase64(CONFIG.xapi.credentials).substring(0, 20) + '...'
    });

    // start
    // Define the actor (agent)
    var actor = {
      "objectType": "Agent",
      //"name": "https://example.com/users/user-v1:1abcb33beeb811dca15f0ac3e47b887blef",
      //"mbox": "mailto:learner@example.com",
      "openid": "https://example.com/users/user-v1:1abcb33beeb811dca15f0ac3e47b887b"
    };  

    // Define the verb
    var verb = {
        "id": "http://adlnet.gov/expapi/verbs/answered",
        "display": { "en-US": "answered" }
    };

    // Define the object (activity) -- this is the id of a specific assessment item or task.
    // Each skill (a.k.a. competency) may have multiple activities that assess the same skill.
    var object = {
        "id": "https://example.com/activity/dca15f0ac3e47b88d91abcb33beeb811_" + item,
        "objectType": "Activity",
        "definition": {
            "name": { "en-US": "Fraction item dca15f0ac3e47b88d91abcb33beeb811_" + item },
            "description": { "en-US": "Example xAPI instrumented button." },
            "type": "http://adlnet.gov/expapi/activities/question"
        }
    };

    // Define the result (optional)
    var result = {
        "response": response,
        "success": success,
        "score": { "scaled": success ? 1.0 : 0.0 }
    };

    // Define the context with context activities and extensions
    var context = {
        "contextActivities": {
            "category": [{
                "id": competency, //"https://example.org/scd/math/55ad59d8-2012-48d5-a95e-b596a1f11dbe",
                "objectType": "Activity",
                "definition": {
                    "name": { "en-US": "6.EE.4" },
                    "type": "http://adlnet.gov/expapi/activities/competency"
                },
            }]
        },
        "extensions": {
            "https://w3id.org/xapi/netc/extensions/user-agent": navigator.userAgent
        }
    };

    // Create the xAPI statement
    var statement = {
        "actor": actor,
        "verb": verb,
        "object": object,
        "result": result,
        "context": context,
        "timestamp": new Date().toISOString()
    };
        // end 

        // Dispatch the statement to the LRS // displaying status to console
        try {
            var result = ADL.XAPIWrapper.sendStatement(statement);
            console.log('Statement sent:', result);
            //alert(`xAPI Statement Sent: \r ${JSON.stringify(statement)} \r\rResult: ${JSON.stringify(result)}`);
            // Inspect the response
          if (result.xhr.status === 400) {
                console.error('Bad Request:', result.xhr.responseText);
          }
        } catch (error) {
            console.error('Error sending statement:', error);
        }

  }

    function check(){
      var success = false;
      var responseValueText = (document.getElementById('response') || {value:''}).value;
      var fb = document.getElementById('feedback'); if (fb) fb.innerHTML = 'Try again.';
      for (let i=0;i<feedbackObjArray.length;i++){
        if (feedbackObjArray[i].match == responseValueText){ if (fb) fb.innerHTML = feedbackObjArray[i].feedback; if (i==0) success = true; }
      }
      var item = '00' + currentItemArrayPos;
      var competency = document.getElementById('skill').value;
      console.log('Success: ' + success);
      send_statement(item, competency, responseValueText, success);
      // After checking an answer, refresh the graph on the right
      refreshGraph();
    }

    // --- Graph logic (adapted from demo.html) ---
    async function createInitialVisualization(data){
      const nodes = new Map(); const dependencies = new Map(); let targetNodeId;
      data['@graph'].forEach(node => {
        if (node['@type'] === 'scd:CompetencyFramework') targetNodeId = node['scd:hasTargetMember'] && node['scd:hasTargetMember'][0];
        if (node['@type'] === 'CompetencyDefinition'){
          nodes.set(node['@id'], node);
          if (node['scd:isSupportedBy']) dependencies.set(node['@id'], node['scd:isSupportedBy']);
        }
      });

      const positions = new Map();
      function calculatePositions(nodeId, column, row=0){ 
        if (!nodes.has(nodeId)) return; 
        const node = nodes.get(nodeId); 
        const code = node['scd:referenceCode']; 
        // Place target node on right side (0.8), prerequisites to the left
        const x = window.innerWidth * (0.8 - column * 0.18); 
        const y = 120 + row * 120; 
        const positionKey = `${code}-${column}-${row}`; 
        positions.set(positionKey,{x,y,id:nodeId}); 
        const prerequisites = dependencies.get(nodeId) || []; 
        prerequisites.forEach((preReqId,index)=> calculatePositions(preReqId, column+1, index)); 
      }

      // Increase vertical spacing between nodes for labels
      function calculatePositions(nodeId, column, row=0){ 
        if (!nodes.has(nodeId)) return; 
        const node = nodes.get(nodeId); 
        const code = node['scd:referenceCode']; 
        // Place target node on right side (0.8), prerequisites to the left
        const x = window.innerWidth * (0.8 - column * 0.18); 
        // Increase vertical spacing between nodes to 160px (was 120px)
        const y = 120 + row * 160; 
        const positionKey = `${code}-${column}-${row}`; 
        positions.set(positionKey,{x,y,id:nodeId}); 
        const prerequisites = dependencies.get(nodeId) || []; 
        prerequisites.forEach((preReqId,index)=> calculatePositions(preReqId, column+1, index)); 
      }

      calculatePositions(targetNodeId,0);
      positions.forEach(position => {
        const node = nodes.get(position.id);
        createCompetencyNode(position.id, node['scd:competencyStatement'], node['scd:referenceCode'], position.x, position.y, 0.0);
      });

      // Draw arrows after DOM positions exist
      // slight delay to allow elements to be laid out
      setTimeout(()=>{
        dependencies.forEach((prereqs,nodeId)=>{
          prereqs.forEach(prereqId=>{
            const fromNodes = Array.from(document.querySelectorAll('[id^="gauge-"]')).filter(el=>el.id==='gauge-'+prereqId);
            const toNodes = Array.from(document.querySelectorAll('[id^="gauge-"]')).filter(el=>el.id==='gauge-'+nodeId);
            fromNodes.forEach(fromNode=>{ toNodes.forEach(toNode=>{
              const fromRect = fromNode.getBoundingClientRect(); const toRect = toNode.getBoundingClientRect(); const svg = document.getElementById('arrows') || createSvgElement();
              drawArrow(svg, fromRect.left + fromRect.width/2 + 60, fromRect.top + fromRect.height/2 +10, toRect.left + toRect.width/2 +30, toRect.top + toRect.height/2 + 10);
            });});
          });
        });
      }, 250);

      return {nodes, positions};
    }

    function createSvgElement(){
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('id','arrows');
      // place on the body so coordinates from getBoundingClientRect() line up to viewport coords
      svg.style.position='absolute';
      svg.style.top='0'; svg.style.left='0'; svg.style.width='100%'; svg.style.height='100%';
      svg.style.pointerEvents='none'; svg.style.zIndex='998';
      // append to body so arrow coordinates map directly to client coordinates
      document.body.appendChild(svg);
      return svg;
    }

    function drawArrow(svg,x1,y1,x2,y2){
      // svg may be positioned at 0,0 of the viewport; ensure coordinates are relative to svg's bbox
      const svgRect = svg.getBoundingClientRect();

      // explicit offsets requested by user to reach the outermost arc
      const offsetX = 40; // move right (for source) / left (for target)
      const offsetY = 30; // move down from center to align with outer arc

      // Compute unit direction vector (used only for arrowhead offset)
      const dx = x2 - x1;
      const dy = y2 - y1;
      const length = Math.sqrt(dx * dx + dy * dy) || 1;
      const unitX = dx / length;
      const unitY = dy / length;

      // Start point: offset from source center to the right-bottom outer arc
      const localX1 = (x1 + offsetX) - svgRect.left;
      const localY1 = (y1 + offsetY) - svgRect.top;

      // End point: offset from target center to the left-bottom outer arc
      const localX2 = (x2 - offsetX) - svgRect.left;
      const localY2 = (y2 + offsetY) - svgRect.top;

      // Small adjustment so arrowhead doesn't overlap the arc
      const arrowheadOffset = 6;
      const newX1 = localX1;
      const newY1 = localY1;
      const newX2 = localX2 - arrowheadOffset * unitX;
      const newY2 = localY2 - arrowheadOffset * unitY;

      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', newX1);
      line.setAttribute('y1', newY1);
      line.setAttribute('x2', newX2);
      line.setAttribute('y2', newY2);
      line.setAttribute('stroke','black');
      line.setAttribute('stroke-width','2');

      if (!document.getElementById('arrowhead')){
        const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
        const marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
        marker.setAttribute('id','arrowhead');
        marker.setAttribute('markerWidth','10');
        marker.setAttribute('markerHeight','7');
        marker.setAttribute('refX','9');
        marker.setAttribute('refY','3.5');
        marker.setAttribute('orient','auto');

        const polygon = document.createElementNS('http://www.w3.org/2000/svg','polygon');
        polygon.setAttribute('points','0 0, 10 3.5, 0 7');
        polygon.setAttribute('fill','black');

        marker.appendChild(polygon);
        defs.appendChild(marker);
        svg.appendChild(defs);
      }

      // marker-end uses the local id
      line.setAttribute('marker-end','url(#arrowhead)');
      svg.appendChild(line);
    }

    function showTooltip(text,x,y){
      const t = document.getElementById('tooltip');
      const graph = document.getElementById('graphArea');
      if (!t || !graph) return;
      // set content first so size can be measured
      t.textContent = text;

      // convert viewport/client coords to graphArea-local coordinates
      const gRect = graph.getBoundingClientRect();
      let left = x - gRect.left + 8; // small gap from cursor
      let top = y - gRect.top + 8;

      // clamp so tooltip stays inside graph area
      const tw = t.offsetWidth || 100;
      const th = t.offsetHeight || 24;
      if (left + tw + 8 > gRect.width) left = Math.max(8, gRect.width - tw - 8);
      if (top + th + 8 > gRect.height) top = Math.max(8, gRect.height - th - 8);

      t.style.left = left + 'px';
      t.style.top = top + 'px';
      t.style.visibility = 'visible';
    }
    function hideTooltip(){ const t=document.getElementById('tooltip'); t.style.visibility='hidden'; }

    function createCompetencyNode(id,text,code,x,y,bktValue){
      // Create a wrapper div to contain both gauge and label
      // Position at the exact (x,y) and center using transform so label sits below the gauge
      const wrapper = document.createElement('div');
      wrapper.setAttribute('id', 'node-' + id);
      wrapper.style.position = 'absolute';
      // place at exact coordinates then center with translate(-50%,-50%) for predictable centering
      wrapper.style.left = x + 'px';
      wrapper.style.top = y + 'px';
      wrapper.style.transform = 'translate(-50%, -50%)';
      wrapper.style.width = '120px'; // Wider to accommodate label
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
      wrapper.style.alignItems = 'center';
      // use gap so spacing is controlled consistently (preferred over per-label margin)
      wrapper.style.gap = '8px';
      wrapper.style.zIndex = '1000';

      // Create gauge container to maintain gauge positioning
      const gaugeContainer = document.createElement('div');
      gaugeContainer.style.width = '60px';
      gaugeContainer.style.height = '60px';

      const gauge = document.createElement('percent-gauge');
      gauge.setAttribute('id','gauge-'+id);
      gauge.setAttribute('gauge-band-color','green');
      gauge.setAttribute('gauge-value-decimal', bktValue.toString());
      gauge.style.width='60px';
      gauge.style.height='60px';
      gauge.style.display='block';

      const label = document.createElement('div');
      label.setAttribute('id', 'label-' + id);
      label.textContent = code;
      label.style.width = '120px';
      label.style.marginTop = '70px'; // space below gauge
      label.style.textAlign = 'center';
      // label spacing handled by wrapper.gap; keep font small to avoid wrapping
      label.style.fontSize = '12px';

      const tooltipText = `${code}: ${text}`;
      const addHover = el=>{
        el.addEventListener('mouseenter', e=> showTooltip(tooltipText, e.clientX, e.clientY));
        el.addEventListener('mousemove', e=> showTooltip(tooltipText, e.clientX, e.clientY));
        el.addEventListener('mouseleave', hideTooltip);
      };

      // Add gauge to its container
      gaugeContainer.appendChild(gauge);
      
      // Build the wrapper structure
      wrapper.appendChild(gaugeContainer);
      wrapper.appendChild(label);
      
      // attach hover to wrapper for reliability
      addHover(wrapper);
      
      // Append the complete structure to document
      document.body.appendChild(wrapper);
    }

    async function refreshGraph(){
      // remove previous graph elements
      const oldSvg = document.getElementById('arrows'); if (oldSvg) oldSvg.remove();
      // remove node containers and labels that were appended to body
      document.querySelectorAll('[id^="node-"]').forEach(el=>el.remove());
      document.querySelectorAll('[id^="label-"]').forEach(el=>el.remove());
      // remove any leftover percent-gauge elements
      document.querySelectorAll('percent-gauge').forEach(el=>el.remove());

      try{
        const response = await fetch('competencyDataFractions.json');
        const data = await response.json();
        const {nodes, positions} = await createInitialVisualization(data);
        // now fetch inferable predictions for each node and update gauges
        for (const [nodeId,node] of nodes){
          try{
            // Log the node we're fetching BKT for
            console.log(`Fetching BKT prediction for node: ${node['scd:referenceCode']} (${nodeId})`);
            
            // Get the current actor from xAPI statements
            const actor = ADL.XAPIWrapper.lrs.actor || {"objectType": "Agent","openid": "https://example.com/users/user-v1:1abcb33beeb811dca15f0ac3e47b887b"};
            if (!actor) {
                console.error('No xAPI actor found - cannot fetch BKT predictions');
                continue;
            }
            
            // Convert xAPI actor to user_id format
            let userId;
            if (actor.mbox) {
                // Use mbox as identifier
                userId = actor.mbox;
            } else if (actor.openid) {
                // Use openid as identifier
                userId = actor.openid;
            } else if (actor.account && actor.account.homePage && actor.account.name) {
                // Use account as identifier
                userId = `${actor.account.homePage}/users/${actor.account.name}`;
            } else {
                console.error('Actor missing required identifier (mbox, openid, or account):', actor);
                continue;
            }
            
            console.log('Using actor for BKT predictions:', { actor, userId });
            
            // Split credentials into auth_id and auth_secret
            const [authId, authSecret] = CONFIG.xapi.credentials.split(':');
            const params = {
              competency_id: node['@id'],
              user_id: userId,
              lrs_url: CONFIG.xapi.endpoint,
              auth_id: authId,
              auth_secret: authSecret
            };
            // Build GET URL with query parameters (no body)
            const url = `${CONFIG.bkt.endpoint}?${new URLSearchParams(params).toString()}`;
            console.log('BKT API Request (GET):', { url, headers: CONFIG.bkt.headers, params });

            const resp = await fetch(url, {
              method: 'GET',
              headers: {
                ...CONFIG.bkt.headers
              },
              mode: 'cors',
              cache: 'no-store'
            });
            console.log('BKT API Response status:', resp.status, resp.statusText);
            
            if (!resp.ok) {
              throw new Error(`HTTP error! status: ${resp.status}`);
            }
            
            const json = await resp.json();
            console.log('BKT API Response for', node['scd:referenceCode'], ':', json);
            
            const gauge = document.getElementById('gauge-' + nodeId);
            if (gauge && json.prediction !== undefined) {
              gauge.setAttribute('gauge-value-decimal', json.prediction.toString());
              console.log(`Updated gauge for ${node['scd:referenceCode']} to ${json.prediction}`);
            } else {
              console.warn(`Could not update gauge for ${node['scd:referenceCode']}:`, 
                !gauge ? 'Gauge element not found' : 'No prediction in response');
            }
          } catch(err){ 
            console.error('Error fetching BKT for', node['scd:referenceCode'], nodeId, '\nError:', err, '\nStack:', err.stack);
          }
        }
      } catch(e){ console.error('Error rendering graph', e); }
    }

    // Function to load and populate skill options from the JSON file
    async function loadSkillOptions() {
      try {
        const response = await fetch('competencyDataFractions.json');
        const data = await response.json();
        const skillSelect = document.getElementById('skill');
        
        // Clear existing options
        skillSelect.innerHTML = '';
        
        // Add new options from the JSON file
        data['@graph'].forEach(node => {
          if (node['@type'] === 'CompetencyDefinition') {
            const option = document.createElement('option');
            option.value = node['@id'];
            option.textContent = `${node['scd:referenceCode']}: ${node['scd:competencyStatement']}`;
            
            // If this is the target competency, select it by default
            const framework = data['@graph'].find(n => n['@type'] === 'scd:CompetencyFramework');
            if (framework && framework['scd:hasTargetMember'] && 
                framework['scd:hasTargetMember'][0] === node['@id']) {
              option.selected = true;
            }
            
            skillSelect.appendChild(option);
          }
        });
        
        // Update the displayed competency ID
        changeSkill();
      } catch (e) {
        console.error('Error loading skill options:', e);
      }
    }

    // initialize both panes when DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{ 
      loadSkillOptions(); // Load skill options first
      nextItem(); 
      refreshGraph();
      const nib = document.getElementById('nextitembutton'); 
      if (nib) nib.addEventListener('click', nextItem);
    });

    // debounced resize to redraw the graph (keeps arrows aligned)
    let resizeTimer = null;
    window.addEventListener('resize', ()=>{
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>{
        refreshGraph();
      }, 250);
    });
  </script>
</body>
</html>
